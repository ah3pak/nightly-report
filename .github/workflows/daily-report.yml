name: Daily Telegram Report

on:
  schedule:
    - cron: "30 17 * * *"   # Ù‡Ø± Ø±ÙˆØ² 17:30 UTC â‰ˆ 21:00 ØªÙ‡Ø±Ø§Ù†
  workflow_dispatch:

jobs:
  send:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install deps
        run: |
          python -m pip install --upgrade pip
          pip install requests jdatetime

      - name: Build message (Jalali date + TGJU + Nobitex)
        id: build
        run: |
          python3 - <<'PY'
          import requests, jdatetime, datetime, json, sys, traceback

          def safe_get_json(url, headers=None, timeout=10):
              try:
                  r = requests.get(url, headers=headers or {}, timeout=timeout)
                  if r.status_code == 200:
                      try:
                          return r.json()
                      except ValueError:
                          return None
                  else:
                      return None
              except Exception:
                  return None

          # --- ØªØ§Ø±ÛŒØ® Ø´Ù…Ø³ÛŒ ---
          now_teh = datetime.datetime.utcnow() + datetime.timedelta(hours=3, minutes=30)
          j_now = jdatetime.datetime.fromgregorian(datetime=now_teh)
          weekday_map = ["Ø¯ÙˆØ´Ù†Ø¨Ù‡","Ø³Ù‡â€ŒØ´Ù†Ø¨Ù‡","Ú†Ù‡Ø§Ø±Ø´Ù†Ø¨Ù‡","Ù¾Ù†Ø¬â€ŒØ´Ù†Ø¨Ù‡","Ø¬Ù…Ø¹Ù‡","Ø´Ù†Ø¨Ù‡","ÛŒÚ©â€ŒØ´Ù†Ø¨Ù‡"]
          weekday = weekday_map[j_now.weekday()]
          jalali_date = f"{weekday} {j_now.day} {j_now.j_months_fa[j_now.month-1]} {j_now.year}"
          greg_date = now_teh.strftime("%d %B %Y â€“ Ø³Ø§Ø¹Øª %H:%M")

          # --- Ø¯Ø±ÛŒØ§ÙØª Ø¯Ø§Ø¯Ù‡ Ø§Ø² TGJU (Ù…Ù‚Ø§ÙˆÙ…) ---
          tgju_items = {
              "Ø·Ù„Ø§ÛŒ Û±Û¸ Ø¹ÛŒØ§Ø±": "geram18",
              "Ø³Ú©Ù‡ Ø§Ù…Ø§Ù…ÛŒ": "gold-24",         # fallback codes â€” Ø§Ú¯Ø± Ø³Ø§ÛŒØª ØªØºÛŒÛŒØ± Ø¯Ø§Ø´ØªØŒ Ù…Ù‚Ø¯Ø§Ø± Ù†Ù‡Ø§ÛŒÛŒ None Ø®ÙˆØ§Ù‡Ø¯ Ø´Ø¯
              "Ù†ÛŒÙ…â€ŒØ³Ú©Ù‡": "sekne-nim",
              "Ø±Ø¨Ø¹â€ŒØ³Ú©Ù‡": "sekne-rob",
              "Ø¯Ù„Ø§Ø±": "price_dollar_rl",
              "ÛŒÙˆØ±Ùˆ": "price_eur"
          }

          tgju_data = {}
          for name, code in tgju_items.items():
              value = None
              tried = []
              # Ù„ÛŒØ³Øª Ø¢Ø¯Ø±Ø³â€ŒÙ‡Ø§ÛŒ Ù…Ø­ØªÙ…Ù„ (ØªØ±ØªÛŒØ¨ Ø§Ø² Ù…Ø­ØªÙ…Ù„â€ŒØªØ± Ø¨Ù‡ Ú©Ù…ØªØ± Ù…Ø­ØªÙ…Ù„)
              candidates = [
                  f"https://www.tgju.org/chart-summary/{code}",
                  f"https://www.tgju.org/profile/{code}",
                  f"https://www.tgju.org/markets/{code}",
              ]
              for url in candidates:
                  tried.append(url)
                  data = safe_get_json(url, timeout=8)
                  if data:
                      # Ø³Ø§Ø®ØªØ§Ø±Ù‡Ø§ÛŒ Ù…Ø®ØªÙ„Ù Ø±Ùˆ Ù¾ÙˆØ´Ø´ Ù…ÛŒâ€ŒØ¯ÛŒÙ…
                      # Ø§Ú¯Ø± Ø¯Ø§Ø¯Ù‡ current -> p Ø¯Ø§Ø´ØªÙ‡ Ø¨Ø§Ø´Ù‡
                      if isinstance(data, dict):
                          if 'current' in data and isinstance(data['current'], dict) and 'p' in data['current']:
                              p = data['current']['p']
                              try:
                                  value = int(float(str(p).replace(',', '')))
                              except:
                                  value = p
                              break
                          # Ù…Ù…Ú©Ù†Ù‡ Ø®ÙˆØ¯Ù json Ù‚ÛŒÙ…Øª Ø±Ùˆ Ø¯Ø± Ú©Ù„ÛŒØ¯Ù‡Ø§ÛŒ Ø¯ÛŒÚ¯Ø±ÛŒ Ø¯Ø§Ø´ØªÙ‡ Ø¨Ø§Ø´Ù‡
                          for k in ['price','p','value','last']:
                              if k in data:
                                  try:
                                      value = int(float(str(data[k]).replace(',', '')))
                                  except:
                                      value = data[k]
                                  break
                          if value is not None:
                              break
              if value is None:
                  # Ø§Ú¯Ø± Ù†ØªÙˆÙ†Ø³ØªÛŒÙ… Ù…Ù‚Ø¯Ø§Ø± Ø±Ùˆ Ø¨Ú¯ÛŒØ±ÛŒÙ…ØŒ Ù…Ù‚Ø¯Ø§Ø± Ù‚Ø§Ø¨Ù„ Ù†Ù…Ø§ÛŒØ´ Ø¨Ø°Ø§Ø±ÛŒÙ…
                  tgju_data[name] = "â€”"
                  print(f"[tgju] could not fetch {name}, tried: {tried}", file=sys.stderr)
              else:
                  tgju_data[name] = value

          # --- Ø¯Ø±ÛŒØ§ÙØª Ø¯Ø§Ø¯Ù‡ Ø±Ù…Ø²Ø§Ø±Ø²Ù‡Ø§ Ø§Ø² Ù†ÙˆØ¨ÛŒØªÚ©Ø³ ---
          nobitex_symbols = {
              "BTC": "btc-usdt",
              "ETH": "eth-usdt",
              "SOL": "sol-usdt",
              "BNB": "bnb-usdt",
              # ØªØªØ±/Ø±ÛŒØ§Ù„ (Ù†ÙˆØ¨ÛŒØªÚ©Ø³ Ù…Ù…Ú©Ù†Ù‡ Ø§Ø³Ù… Ù…ØªÙØ§ÙˆØª Ø¯Ø§Ø´ØªÙ‡ Ø¨Ø§Ø´Ù‡)
              "USDT": "usdt-rls"
          }

          nobi_prices = {}
          for sym, pair in nobitex_symbols.items():
              price = None
              try:
                  r = requests.get(f"https://api.nobitex.ir/market/stats?symbol={pair}", timeout=8)
                  if r.status_code == 200:
                      j = r.json()
                      if 'stats' in j and pair in j['stats']:
                          price = float(j['stats'][pair].get('latest', 0))
                      else:
                          # Ø¨Ø¹Ø¶ÛŒ ÙˆÙ‚Øªâ€ŒÙ‡Ø§ Ø³Ø§Ø®ØªØ§Ø± Ù…ØªÙØ§ÙˆØªÙ‡
                          # fallback: Ø§Ú¯Ø± Ø®ÙˆØ¯Ø´ ÛŒÚ© Ù…Ù‚Ø¯Ø§Ø± Ø¹Ø¯Ø¯ÛŒ Ø¯Ø§Ø±Ø¯:
                          if isinstance(j, dict) and 'latest' in j:
                              price = float(j['latest'])
                  else:
                      print(f"[nobitex] non-200 for {pair}: {r.status_code}", file=sys.stderr)
              except Exception as e:
                  print(f"[nobitex] error fetching {pair}: {e}", file=sys.stderr)
              if price is None:
                  nobi_prices[sym] = None
              else:
                  nobi_prices[sym] = price

          # ØªØ¨Ø¯ÛŒÙ„ ØªØªØ± Ø¨Ù‡ ØªÙˆÙ…Ø§Ù† (Ø§Ú¯Ø± Ù…ÙˆØ¬ÙˆØ¯)
          t_usdt = nobi_prices.get('USDT') or nobi_prices.get('USDT'.upper()) or None

          # Ø³Ø§Ø®Øª Ù¾ÛŒØ§Ù… Ø¨Ù‡ Ø´Ú©Ù„ Ø®ÙˆØ§Ù†Ø§
          def fmt(x):
              try:
                                          # Ø§Ú¯Ø± Ø¹Ø¯Ø¯ Ø¨Ø§Ø´Ù‡ ÙØ±Ù…Øª Ù‡Ø²Ø§Ø±Ú¯Ø§Ù†
                  if isinstance(x, (int, float)):
                      return f"{int(x):,}"
                  else:
                      return str(x)
              except:
                  return str(x)

          msg = f"""ğŸ“Š Ú¯Ø²Ø§Ø±Ø´ Ø±ÙˆØ² Ø¨Ø§Ø²Ø§Ø± Ø·Ù„Ø§ØŒ Ø§Ø±Ø² Ùˆ Ø±Ù…Ø²Ø§Ø±Ø²Ù‡Ø§
ğŸ—“ï¸ {jalali_date} | {greg_date}

ğŸŸ¡ Ø¨Ø§Ø²Ø§Ø± Ø·Ù„Ø§
Ø·Ù„Ø§ÛŒ Û±Û¸ Ø¹ÛŒØ§Ø±: {fmt(tgju_data.get('Ø·Ù„Ø§ÛŒ Û±Û¸ Ø¹ÛŒØ§Ø±'))} ØªÙˆÙ…Ø§Ù†
Ø³Ú©Ù‡ Ø§Ù…Ø§Ù…ÛŒ: {fmt(tgju_data.get('Ø³Ú©Ù‡ Ø§Ù…Ø§Ù…ÛŒ'))} ØªÙˆÙ…Ø§Ù†
Ù†ÛŒÙ…â€ŒØ³Ú©Ù‡: {fmt(tgju_data.get('Ù†ÛŒÙ…â€ŒØ³Ú©Ù‡'))} ØªÙˆÙ…Ø§Ù†
Ø±Ø¨Ø¹â€ŒØ³Ú©Ù‡: {fmt(tgju_data.get('Ø±Ø¨Ø¹â€ŒØ³Ú©Ù‡'))} ØªÙˆÙ…Ø§Ù†

ğŸ’µ Ø¨Ø§Ø²Ø§Ø± Ø§Ø±Ø²
Ø¯Ù„Ø§Ø±: {fmt(tgju_data.get('Ø¯Ù„Ø§Ø±'))} ØªÙˆÙ…Ø§Ù† | ÛŒÙˆØ±Ùˆ: {fmt(tgju_data.get('ÛŒÙˆØ±Ùˆ'))} ØªÙˆÙ…Ø§Ù†

ğŸª™ Ø¨Ø§Ø²Ø§Ø± Ø±Ù…Ø²Ø§Ø±Ø²Ù‡Ø§ (Ù†ÙˆØ¨ÛŒØªÚ©Ø³)
"""

          # Ø±Ù…Ø²Ø§Ø±Ø²Ù‡Ø§ Ø±Ø§ Ø¨Ø§ ØªØ¨Ø¯ÛŒÙ„ ØªØªØ± (Ø§Ú¯Ø± Ø¯Ø§Ø±ÛŒÙ…) Ù†Ù…Ø§ÛŒØ´ Ù…ÛŒâ€ŒÚ©Ù†ÛŒÙ…
          for k in ("BTC","ETH","SOL","BNB"):
              p = nobi_prices.get(k)
              if p is None:
                  msg += f"{k}: â€”\n"
              else:
                  if t_usdt:
                      try:
                          approx_irr = int(p * t_usdt)
                          msg += f"{k}: {p:.6g} USDT â‰ˆ {approx_irr:,} ØªÙˆÙ…Ø§Ù†\n"
                      except:
                          msg += f"{k}: {p:.6g} USDT\n"
                  else:
                      msg += f"{k}: {p:.6g} USDT\n"

          if t_usdt:
              msg += f"ØªØªØ±: {int(t_usdt):,} ØªÙˆÙ…Ø§Ù†\n"

          msg += f"\n(Ø§Ø±Ø³Ø§Ù„ Ø®ÙˆØ¯Ú©Ø§Ø± GitHub Actions â€“ {now_teh.strftime('%Y/%m/%d - %H:%M')} Tehran)\n"

          # Ø°Ø®ÛŒØ±Ù‡ Ùˆ Ø®Ø±ÙˆØ¬ÛŒ
          with open('msg.txt', 'w', encoding='utf-8') as f:
              f.write(msg)

          print(msg)
          print("âœ… Message built successfully", file=sys.stderr)

          # write output safely to GITHUB_OUTPUT
          # echo "message<<EOF\n...EOF" >> $GITHUB_OUTPUT
          out = msg
          # escape for writing to GITHUB_OUTPUT
          sys.stdout.write(f"message<<'EOF'\\n{out}\\nEOF\\n")
          PY
        shell: bash

      - name: Persist message to GITHUB_OUTPUT
        # Ø®ÙˆØ§Ù†Ø¯Ù† Ø®Ø· Ø§Ø² Ù…Ø±Ø­Ù„Ù‡Ù” Ù‚Ø¨Ù„ Ùˆ Ø§Ù¾Ù†Ø¯ Ø¨Ù‡ GITHUB_OUTPUT â€” Ú†ÙˆÙ† step Ù‚Ø¨Ù„ Ú†Ø§Ù¾ Ú©Ø±Ø¯
        run: |
          # read the stdout of the previous step from the job logs is not possible,
          # ÙˆÙ„ÛŒ Ù…Ø§ Ø¯Ø± Ù…Ø±Ø­Ù„Ù‡ Ù‚Ø¨Ù„ Ø®Ø· "message<<'EOF'..." Ú†Ø§Ù¾ Ú©Ø±Ø¯ÛŒÙ…Ø› GitHub Actions Ø¢Ù† Ø±Ø§ Ø¨Ù‡ Ø®Ø±ÙˆØ¬ÛŒ Ù…Ø±Ø­Ù„Ù‡ ØªØ¨Ø¯ÛŒÙ„ Ù…ÛŒâ€ŒÚ©Ù†Ø¯.
          # Ø§ÛŒÙ† Ø®Ø· ØªØ¶Ù…ÛŒÙ† Ù…ÛŒâ€ŒÚ©Ù†Ø¯ Ú©Ù‡ Ø§Ú¯Ø± Ù…Ù‚Ø¯Ø§Ø± Ø¯Ø± output Ù…ÙˆØ¬ÙˆØ¯ Ø¨Ø§Ø´Ø¯ØŒ Ø¨Ù‡ GITHUB_OUTPUT Ø§Ø¶Ø§ÙÙ‡ Ø´ÙˆØ¯.
          if [ -n "${{ steps.build.outputs.message }}" ]; then
            echo "message<<'EOF'" >> $GITHUB_OUTPUT
            echo "${{ steps.build.outputs.message }}" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
          else
            # fallback: Ø§Ø² ÙØ§ÛŒÙ„ msg.txt Ø¨Ø®ÙˆØ§Ù†
            echo "message<<'EOF'" >> $GITHUB_OUTPUT
            sed 's/\'\''/'\''"'"'\''/g' msg.txt >> $GITHUB_OUTPUT || cat msg.txt >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
          fi
        shell: bash

      - name: Send to Telegram
        env:
          BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          if [ -z "$BOT_TOKEN" ] || [ -z "$CHAT_ID" ]; then
            echo "Missing TELEGRAM_BOT_TOKEN or TELEGRAM_CHAT_ID secret" >&2
            exit 1
          fi

          # Ù¾ÛŒØ§Ù… Ø±Ø§ Ù…Ø³ØªÙ‚ÛŒÙ… Ø§Ø² ÙØ§ÛŒÙ„ Ø§Ø±Ø³Ø§Ù„ Ù…ÛŒâ€ŒÚ©Ù†ÛŒÙ… (ÙØ±Ù…Øª ÙØ±Ù… Ø¨Ø§Ø¹Ø« Ø§Ù…Ù†â€ŒØªØ± Ø¨ÙˆØ¯Ù†Ù Ù…ØªÙ† Ú†Ù†Ø¯Ø®Ø·ÛŒ Ù…ÛŒâ€ŒØ´ÙˆØ¯)
          curl -sS -X POST "https://api.telegram.org/bot${BOT_TOKEN}/sendMessage" \
            -F chat_id="${CHAT_ID}" \
            -F text="$(cat msg.txt)" \
            -F parse_mode="HTML" \
            -F disable_web_page_preview=true
