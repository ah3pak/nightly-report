name: Daily Telegram Report

on:
  schedule:
    - cron: "30 17 * * *"  # Ù‡Ø± Ø±ÙˆØ² 21:00 Ø¨Ù‡ ÙˆÙ‚Øª ØªÙ‡Ø±Ø§Ù†
  workflow_dispatch:

jobs:
  send:
    runs-on: ubuntu-latest

    steps:
      - name: Install deps
        run: |
          sudo apt-get update
          pip install requests jdatetime

      - name: Build message (Jalali date + TGJU + Nobitex)
        id: build
        run: |
          python3 - <<'PY'
          import requests, jdatetime, datetime, json

          # --- ØªØ§Ø±ÛŒØ® Ø´Ù…Ø³ÛŒ ---
          now_teh = datetime.datetime.utcnow() + datetime.timedelta(hours=3, minutes=30)
          j_now = jdatetime.datetime.fromgregorian(datetime=now_teh)
          weekday_map = ["Ø¯ÙˆØ´Ù†Ø¨Ù‡","Ø³Ù‡â€ŒØ´Ù†Ø¨Ù‡","Ú†Ù‡Ø§Ø±Ø´Ù†Ø¨Ù‡","Ù¾Ù†Ø¬â€ŒØ´Ù†Ø¨Ù‡","Ø¬Ù…Ø¹Ù‡","Ø´Ù†Ø¨Ù‡","ÛŒÚ©â€ŒØ´Ù†Ø¨Ù‡"]
          weekday = weekday_map[j_now.weekday()]
          jalali_date = f"{weekday} {j_now.day} {j_now.j_months_fa[j_now.month-1]} {j_now.year}"
          greg_date = now_teh.strftime("%d %B %Y â€“ Ø³Ø§Ø¹Øª %H:%M")

          # --- Ø¯Ø±ÛŒØ§ÙØª Ø¯Ø§Ø¯Ù‡ Ø§Ø² TGJU ---
          tgju_items = {
              "Ø·Ù„Ø§ÛŒ Û±Û¸ Ø¹ÛŒØ§Ø±": "geram18",
              "Ø³Ú©Ù‡ Ø§Ù…Ø§Ù…ÛŒ": "sekee",
              "Ù†ÛŒÙ…â€ŒØ³Ú©Ù‡": "sekne-nim",
              "Ø±Ø¨Ø¹â€ŒØ³Ú©Ù‡": "sekne-rob",
              "Ø¯Ù„Ø§Ø±": "price_dollar_rl",
              "ÛŒÙˆØ±Ùˆ": "price_eur"
          }

          tgju_data = {}
          for name, code in tgju_items.items():
              url = f"https://www.tgju.org/chart-summary/{code}"
              r = requests.get(url)
              r.raise_for_status()
              data = r.json()
              p = data['current']['p'] if 'current' in data else None
              try:
                  p = int(float(p.replace(',', '')))
              except:
                  pass
              tgju_data[name] = p

          # --- Ø¯Ø±ÛŒØ§ÙØª Ø¯Ø§Ø¯Ù‡ Ø±Ù…Ø²Ø§Ø±Ø²Ù‡Ø§ Ø§Ø² Ù†ÙˆØ¨ÛŒØªÚ©Ø³ ---
          nobitex_symbols = {
              "BTC": "btc-usdt",
              "ETH": "eth-usdt",
              "SOL": "sol-usdt",
              "BNB": "bnb-usdt",
              "USDT": "usdt-rls"
          }

          nobi_prices = {}
          for sym, pair in nobitex_symbols.items():
              r = requests.get(f"https://api.nobitex.ir/market/stats?symbol={pair}")
              r.raise_for_status()
              data = r.json()['stats'][pair]
              nobi_prices[sym] = float(data['latest'])

          # ØªØ¨Ø¯ÛŒÙ„ ØªØªØ± Ø¨Ù‡ ØªÙˆÙ…Ø§Ù†
          t_usdt = nobi_prices['USDT']

          msg = f"""ðŸ“Š Ú¯Ø²Ø§Ø±Ø´ Ø±ÙˆØ² Ø¨Ø§Ø²Ø§Ø± Ø·Ù„Ø§ØŒ Ø§Ø±Ø² Ùˆ Ø±Ù…Ø²Ø§Ø±Ø²Ù‡Ø§
ðŸ—“ï¸ {jalali_date} | {greg_date}

ðŸŸ¡ Ø¨Ø§Ø²Ø§Ø± Ø·Ù„Ø§
Ø·Ù„Ø§ÛŒ Û±Û¸ Ø¹ÛŒØ§Ø±: {tgju_data['Ø·Ù„Ø§ÛŒ Û±Û¸ Ø¹ÛŒØ§Ø±']:,} ØªÙˆÙ…Ø§Ù†
Ø³Ú©Ù‡ Ø§Ù…Ø§Ù…ÛŒ: {tgju_data['Ø³Ú©Ù‡ Ø§Ù…Ø§Ù…ÛŒ']:,} ØªÙˆÙ…Ø§Ù†
Ù†ÛŒÙ…â€ŒØ³Ú©Ù‡: {tgju_data['Ù†ÛŒÙ…â€ŒØ³Ú©Ù‡']:,} ØªÙˆÙ…Ø§Ù†
Ø±Ø¨Ø¹â€ŒØ³Ú©Ù‡: {tgju_data['Ø±Ø¨Ø¹â€ŒØ³Ú©Ù‡']:,} ØªÙˆÙ…Ø§Ù†

ðŸ’µ Ø¨Ø§Ø²Ø§Ø± Ø§Ø±Ø²
Ø¯Ù„Ø§Ø±: {tgju_data['Ø¯Ù„Ø§Ø±']:,} ØªÙˆÙ…Ø§Ù† | ÛŒÙˆØ±Ùˆ: {tgju_data['ÛŒÙˆØ±Ùˆ']:,} ØªÙˆÙ…Ø§Ù†

ðŸª™ Ø¨Ø§Ø²Ø§Ø± Ø±Ù…Ø²Ø§Ø±Ø²Ù‡Ø§ (Ø¨Ø± Ø§Ø³Ø§Ø³ Ù†ÙˆØ¨ÛŒØªÚ©Ø³)
Ø¨ÛŒØªâ€ŒÚ©ÙˆÛŒÙ†: {nobi_prices['BTC']:.0f} USDT â‰ˆ {nobi_prices['BTC'] * t_usdt:,.0f} ØªÙˆÙ…Ø§Ù†
Ø§ØªØ±ÛŒÙˆÙ…: {nobi_prices['ETH']:.0f} USDT â‰ˆ {nobi_prices['ETH'] * t_usdt:,.0f} ØªÙˆÙ…Ø§Ù†
Ø³ÙˆÙ„Ø§Ù†Ø§: {nobi_prices['SOL']:.0f} USDT â‰ˆ {nobi_prices['SOL'] * t_usdt:,.0f} ØªÙˆÙ…Ø§Ù†
Ø¨Ø§ÛŒÙ†Ù†Ø³â€ŒÚ©ÙˆÛŒÙ†: {nobi_prices['BNB']:.0f} USDT â‰ˆ {nobi_prices['BNB'] * t_usdt:,.0f} ØªÙˆÙ…Ø§Ù†
ØªØªØ±: {t_usdt:,.0f} ØªÙˆÙ…Ø§Ù†

(Ø§Ø±Ø³Ø§Ù„ Ø®ÙˆØ¯Ú©Ø§Ø± GitHub Actions â€“ {now_teh.strftime("%Y/%m/%d - %H:%M")} Tehran)
"""

          print(msg)
          with open("msg.txt", "w", encoding="utf-8") as f:
              f.write(msg)
          print("âœ… Message built successfully")

          # Ø®Ø±ÙˆØ¬ÛŒ Ø¨Ø±Ø§ÛŒ Ø§Ú©Ø´Ù† Ø¨Ø¹Ø¯ÛŒ
          msg_json = json.dumps(msg, ensure_ascii=False)
          print(f"::set-output name=message::{msg_json}")
          PY

      - name: Send to Telegram
        run: |
          curl -sS -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage" \
            -H "Content-Type: application/json" \
            -d "{\"chat_id\":\"${{ secrets.TELEGRAM_CHAT_ID }}\",\"text\":${{ steps.build.outputs.message }},\"parse_mode\":\"HTML\",\"disable_web_page_preview\":true}"
