name: Daily Telegram Report (multi-source, stable)

on:
  schedule:
    - cron: "30 17 * * *"   # هر روز 17:30 UTC ≈ 21:00 Tehran
  workflow_dispatch: {}

jobs:
  send:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Python 3.10
        uses: actions/setup-python@v4
        with:
          python-version: "3.10"

      - name: Install Python deps
        run: |
          python -m pip install --upgrade pip
          pip install requests beautifulsoup4 jdatetime

      - name: Download previous values artifact (if exists)
        uses: actions/download-artifact@v4
        with:
          name: last-values
          path: prev
        continue-on-error: true

      - name: Run message builder script
        run: |
          python3 .github/scripts/build_msg.py

      - name: Show preview (first 40 lines)
        run: |
          echo "---- msg.txt preview ----"
          sed -n '1,40p' msg.txt || true
          echo "---- end preview ----"

      - name: Send to Telegram (single message)
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          if [ -z "$TELEGRAM_BOT_TOKEN" ] || [ -z "$TELEGRAM_CHAT_ID" ]; then
            echo "ERROR: TELEGRAM_BOT_TOKEN or TELEGRAM_CHAT_ID not set"
            exit 1
          fi
          curl -sS -X POST "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage" \
            --data-urlencode "chat_id=${TELEGRAM_CHAT_ID}" \
            --data-urlencode "text@msg.txt" \
            --data-urlencode "parse_mode=HTML" \
            --fail -o response.json || (echo "curl failed, response:"; cat response.json || true; exit 1)
          echo "Telegram response:"
          cat response.json || true

      - name: Upload artifacts (last-values + msg)
        uses: actions/upload-artifact@v4
        with:
          name: last-values
          path: |
            last-values.json
            msg.txt
