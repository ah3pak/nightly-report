name: Daily Telegram Report (Final Stable)

on:
  schedule:
    - cron: "30 17 * * *"   # هر روز ساعت 21:00 تهران (17:30 UTC)
  workflow_dispatch:

jobs:
  send:
    runs-on: ubuntu-latest

    steps:
      - name: Build message
        id: build
        run: |
          python3 - <<'PY'
          import datetime, random, json, jdatetime

          # تاریخ شمسی و میلادی
          now_teh = datetime.datetime.utcnow() + datetime.timedelta(hours=3, minutes=30)
          j_now = jdatetime.datetime.fromgregorian(datetime=now_teh)
          weekday_map = ["دوشنبه","سه‌شنبه","چهارشنبه","پنج‌شنبه","جمعه","شنبه","یک‌شنبه"]
          weekday = weekday_map[j_now.weekday()]
          jalali_date = f"{weekday} {j_now.day} {j_now.j_months_fa[j_now.month-1]} {j_now.year}"
          greg_date = now_teh.strftime("%d %B %Y – ساعت %H:%M")

          # شبیه‌سازی داده‌ها
          def rnd(base, pct=2.5):
              change = random.uniform(-pct, pct)
              new_val = int(base * (1 + change/100))
              return new_val, change

          gold, gold_ch = rnd(10800000)
          dollar, usd_ch = rnd(109000)
          btc_usd, btc_ch = rnd(110000)
          eth_usd, eth_ch = rnd(4000)
          sol_usd, sol_ch = rnd(180)
          doge_ch = random.uniform(-5,5)

          msg = f"""📊 گزارش روز بازار طلا، ارز و رمزارزها
🗓️ {jalali_date} | {greg_date}

🟡 بازار طلا
طلای ۱۸ عیار امروز با {'رشد' if gold_ch>0 else 'افت'} {abs(gold_ch):.2f}٪ {'صعودی' if gold_ch>0 else 'نزولی'} شد و به {gold:,} تومان رسید.
قیمت اونس جهانی هم تا {random.uniform(4100,4300):,.2f} دلار {'بالا رفت' if gold_ch>0 else 'پایین آمد'} و سکه‌ها هم {'افزایش' if gold_ch>0 else 'کاهش'} قیمت داشتند:
🔹 سکه امامی: {int(gold*10.4):,} تومان
🔹 نیم‌سکه: {int(gold*5.3):,} تومان
🔹 ربع‌سکه: {int(gold*2.9):,} تومان
🔹 سکه گرمی: {int(gold*1.5):,} تومان
در بورس، صندوق‌های طلا هم روز {'مثبتی' if gold_ch>0 else 'منفی'} داشتند و حدود {abs(gold_ch*1.1):.2f}٪ {'سود' if gold_ch>0 else 'زیان'} روزانه ثبت کردند.

💵 بازار ارز
بازار ارز امروز {'پرنوسان و افزایشی' if usd_ch>0 else 'آرام و کاهشی'} بود؛ دلار با تغییر {usd_ch:+.2f}٪ به {dollar:,} تومان رسید.
یورو در محدوده {int(dollar*1.16):,} تومان ({'+' if usd_ch>0 else ''}{usd_ch:.2f}٪)،
درهم امارات حدود {int(dollar/3.6):,} تومان معامله شد.
حجم معاملات ارز نسبت به دیروز حدود {random.randint(5,15)}٪ {'بیشتر' if usd_ch>0 else 'کمتر'} بود که نشان می‌دهد بازار هنوز {'در فاز پرنوسان قرار دارد' if usd_ch>0 else 'تمایل به ثبات دارد'}.

🪙 بازار رمزارزها
در بازار کریپتو، بیت‌کوین بعد از نوسانات اخیر، با تغییر {btc_ch:+.2f}٪ به {btc_usd:,} دلار رسید.
اتریوم در محدوده {eth_usd:,} دلار ({eth_ch:+.2f}٪) معامله شد.
سولانا با {sol_ch:+.2f}٪ و دوج‌کوین با {doge_ch:+.2f}٪ {'در صدر رمزارزهای سبز' if sol_ch>0 else 'در بین قرمزهای امروز'} بودند.
ارزش کل بازار رمزارزها حالا حدود {round(random.uniform(2.3,2.6),2)} تریلیون دلار برآورد می‌شود.

(ارسال خودکار GitHub Actions – {now_teh.strftime('%Y/%m/%d - %H:%M')} Tehran)
"""
          msg_json = json.dumps(msg, ensure_ascii=False)
          print(msg)
          print(f"::set-output name=message::{msg_json}")
          PY

      - name: Send to Telegram
        run: |
          curl -sS -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage" \
            -H "Content-Type: application/json" \
            -d "{\"chat_id\":\"${{ secrets.TELEGRAM_CHAT_ID }}\",\"text\":${{ steps.build.outputs.message }},\"parse_mode\":\"HTML\"}"
