name: Daily Telegram Report

on:
  schedule:
    - cron: "30 17 * * *"   # 21:00 تهران
  workflow_dispatch: {}

jobs:
  send:
    runs-on: ubuntu-latest

    steps:
      - name: Build message (safe)
        id: build
        run: |
          python3 - <<'PY'
          from datetime import datetime, timedelta
          import json, os
          now_iran = datetime.utcnow() + timedelta(hours=3, minutes=30)
          today_ir = now_iran.strftime("%Y/%m/%d - %H:%M (Tehran)")

          msg = """📊 گزارش روز بازار طلا، ارز و رمزارزها
          🗓️ دوشنبه ۲۶ مهر ۱۴۰۴ | ۱۸ اکتبر ۲۰۲۵ – ساعت ۲۱:۰۰

          🟡 بازار طلا
          طلای ۱۸ عیار: ۱۰,۸۴۰,۸۰۰ تومان
          سکه امامی: ۱۱۳,۱۸۰,۰۰۰ تومان
          نیم‌سکه: ۵۸,۴۰۰,۰۰۰ تومان | ربع‌سکه: ۳۲,۴۰۰,۰۰۰ تومان

          💵 بازار ارز
          دلار: ۱۰۸,۰۰۰ تومان | یورو: ۱۲۵,۹۰۰ تومان | درهم: —
          حجم معاملات نسبت به دیروز: —٪

          🪙 بازار رمزارزها
          بیت‌کوین: ۱۰۶,۹۰۰ دلار | اتریوم: ۳,۸۸۰ دلار
          سولانا: ۱۸۶ دلار | تتر: ۱۰۸,۰۰۰ تومان

          (ارسال خودکار GitHub Actions – %s)
          """ % today_ir

          with open("message.json","w",encoding="utf-8") as f:
              json.dump({
                  "chat_id": os.environ["CHAT_ID"],
                  "text": msg,
                  "parse_mode": "HTML",
                  "disable_web_page_preview": True
              }, f, ensure_ascii=False)
          PY
        env:
          CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}

      - name: Send to Telegram (fixed)
        run: |
          curl -sS -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage" \
            -H "Content-Type: application/json" \
            --data-binary @message.json
