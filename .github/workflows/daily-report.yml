name: Daily Telegram Report

on:
  schedule:
    - cron: "30 17 * * *"   # Ù‡Ø± Ø±ÙˆØ² Ø³Ø§Ø¹Øª 21:00 ØªÙ‡Ø±Ø§Ù† â‰ˆ 17:30 UTC
  workflow_dispatch: {}

jobs:
  send:
    runs-on: ubuntu-latest

    steps:
      - name: Install dependencies
        run: |
          sudo apt-get update -y
          pip install --upgrade pip
          pip install requests jdatetime

      - name: Build message (Jalali date + TGJU + Nobitex)
        id: build
        run: |
          python3 - <<'PY'
import requests, jdatetime, datetime, json, os

def safe_get_json(url, headers=None, timeout=10):
    try:
        r = requests.get(url, headers=headers or {}, timeout=timeout)
        if r.status_code == 200:
            return r.json()
    except Exception:
        pass
    return None

# --- ØªØ§Ø±ÛŒØ® Ø´Ù…Ø³ÛŒ ---
now_teh = datetime.datetime.utcnow() + datetime.timedelta(hours=3, minutes=30)
j_now = jdatetime.datetime.fromgregorian(datetime=now_teh)
weekday_map = ["Ø¯ÙˆØ´Ù†Ø¨Ù‡","Ø³Ù‡â€ŒØ´Ù†Ø¨Ù‡","Ú†Ù‡Ø§Ø±Ø´Ù†Ø¨Ù‡","Ù¾Ù†Ø¬â€ŒØ´Ù†Ø¨Ù‡","Ø¬Ù…Ø¹Ù‡","Ø´Ù†Ø¨Ù‡","ÛŒÚ©â€ŒØ´Ù†Ø¨Ù‡"]
weekday = weekday_map[j_now.weekday()]
jalali_date = f"{weekday} {j_now.day} {j_now.j_months_fa[j_now.month-1]} {j_now.year}"
greg_date = now_teh.strftime("%d %B %Y â€“ Ø³Ø§Ø¹Øª %H:%M")

# --- Ø¯Ø±ÛŒØ§ÙØª Ø¯Ø§Ø¯Ù‡ Ø§Ø² TGJU ---
tgju_items = {
    "Ø·Ù„Ø§ÛŒ Û±Û¸ Ø¹ÛŒØ§Ø±": "geram18",
    "Ø³Ú©Ù‡ Ø§Ù…Ø§Ù…ÛŒ": "sekee",
    "Ù†ÛŒÙ…â€ŒØ³Ú©Ù‡": "sekne-nim",
    "Ø±Ø¨Ø¹â€ŒØ³Ú©Ù‡": "sekne-rob",
    "Ø¯Ù„Ø§Ø±": "price_dollar_rl",
    "ÛŒÙˆØ±Ùˆ": "price_eur"
}

tgju_data = {}
for name, code in tgju_items.items():
    data = safe_get_json(f"https://www.tgju.org/chart-summary/{code}")
    if data and 'current' in data and 'p' in data['current']:
        try:
            tgju_data[name] = int(float(str(data['current']['p']).replace(',', '')))
        except:
            tgju_data[name] = "â€”"
    else:
        tgju_data[name] = "â€”"

# --- Ø¯Ø±ÛŒØ§ÙØª Ø±Ù…Ø²Ø§Ø±Ø²Ù‡Ø§ Ø§Ø² Nobitex ---
nobi_symbols = {
    "BTC": "btc-usdt",
    "ETH": "eth-usdt",
    "SOL": "sol-usdt",
    "BNB": "bnb-usdt",
    "USDT": "usdt-rls"
}

nobi_prices = {}
for s, pair in nobi_symbols.items():
    r = safe_get_json(f"https://api.nobitex.ir/market/stats?symbol={pair}")
    try:
        nobi_prices[s] = float(r['stats'][pair]['latest'])
    except:
        nobi_prices[s] = None

t_usdt = nobi_prices.get("USDT", None)

def fmt(x):
    try:
        return f"{int(x):,}"
    except:
        return str(x)

msg = f"""ðŸ“Š Ú¯Ø²Ø§Ø±Ø´ Ø±ÙˆØ² Ø¨Ø§Ø²Ø§Ø± Ø·Ù„Ø§ØŒ Ø§Ø±Ø² Ùˆ Ø±Ù…Ø²Ø§Ø±Ø²Ù‡Ø§
ðŸ—“ï¸ {jalali_date} | {greg_date}

ðŸŸ¡ Ø¨Ø§Ø²Ø§Ø± Ø·Ù„Ø§
Ø·Ù„Ø§ÛŒ Û±Û¸ Ø¹ÛŒØ§Ø±: {fmt(tgju_data['Ø·Ù„Ø§ÛŒ Û±Û¸ Ø¹ÛŒØ§Ø±'])} ØªÙˆÙ…Ø§Ù†
Ø³Ú©Ù‡ Ø§Ù…Ø§Ù…ÛŒ: {fmt(tgju_data['Ø³Ú©Ù‡ Ø§Ù…Ø§Ù…ÛŒ'])} ØªÙˆÙ…Ø§Ù†
Ù†ÛŒÙ…â€ŒØ³Ú©Ù‡: {fmt(tgju_data['Ù†ÛŒÙ…â€ŒØ³Ú©Ù‡'])} ØªÙˆÙ…Ø§Ù†
Ø±Ø¨Ø¹â€ŒØ³Ú©Ù‡: {fmt(tgju_data['Ø±Ø¨Ø¹â€ŒØ³Ú©Ù‡'])} ØªÙˆÙ…Ø§Ù†

ðŸ’µ Ø¨Ø§Ø²Ø§Ø± Ø§Ø±Ø²
Ø¯Ù„Ø§Ø±: {fmt(tgju_data['Ø¯Ù„Ø§Ø±'])} ØªÙˆÙ…Ø§Ù† | ÛŒÙˆØ±Ùˆ: {fmt(tgju_data['ÛŒÙˆØ±Ùˆ'])} ØªÙˆÙ…Ø§Ù†

ðŸª™ Ø¨Ø§Ø²Ø§Ø± Ø±Ù…Ø²Ø§Ø±Ø²Ù‡Ø§ (Ù†ÙˆØ¨ÛŒØªÚ©Ø³)
"""

for k in ("BTC","ETH","SOL","BNB"):
    p = nobi_prices.get(k)
    if p and t_usdt:
        msg += f"{k}: {p:.2f} USDT â‰ˆ {p*t_usdt:,.0f} ØªÙˆÙ…Ø§Ù†\n"
    elif p:
        msg += f"{k}: {p:.2f} USDT\n"
    else:
        msg += f"{k}: â€”\n"

if t_usdt:
    msg += f"ØªØªØ±: {t_usdt:,.0f} ØªÙˆÙ…Ø§Ù†\n"

msg += f"\n(Ø§Ø±Ø³Ø§Ù„ Ø®ÙˆØ¯Ú©Ø§Ø± GitHub Actions â€“ {now_teh.strftime('%Y/%m/%d - %H:%M')} Tehran)"

# Ø°Ø®ÛŒØ±Ù‡ Ù…Ø­Ù„ÛŒ (Artifact/manual check)
with open("msg.txt", "w", encoding="utf-8") as f:
    f.write(msg)

# Ø®Ø±ÙˆØ¬ÛŒ Ø¨Ø±Ø§ÛŒ Ø§Ú©Ø´Ù† Ø¨Ø¹Ø¯ÛŒ (Ø±ÙˆØ´ Ø¯Ø±Ø³Øª: append Ø¨Ù‡ GITHUB_OUTPUT)
gh_out = os.environ.get("GITHUB_OUTPUT")
if gh_out:
    with open(gh_out, "a", encoding="utf-8") as gh:
        gh.write("message<<EOF\n")
        gh.write(msg)
        gh.write("\nEOF\n")
else:
    # fallback for older runners (Ø®ÛŒÙ„ÛŒ Ù†Ø§Ø¯Ø±)
    print("::set-output name=message::" + json.dumps(msg, ensure_ascii=False))
print("âœ… Message built")
PY

      - name: Send to Telegram
        run: |
          curl -sS -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage" \
            -H "Content-Type: application/json" \
            -d "{\"chat_id\":\"${{ secrets.TELEGRAM_CHAT_ID }}\",\"text\":${{ steps.build.outputs.message }},\"parse_mode\":\"HTML\",\"disable_web_page_preview\":true}"

      - name: Upload message artifact (msg.txt)
        uses: actions/upload-artifact@v4
        with:
          name: nightly-msg
          path: msg.txt
