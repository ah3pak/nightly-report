name: Daily Telegram Report (Stable, no-API)

on:
  schedule:
    - cron: "30 17 * * *"   # هر روز ساعت 21:00 تهران ≈ 17:30 UTC
  workflow_dispatch: {}

jobs:
  send:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.10"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install jdatetime

      - name: Build message (generate msg.txt)
        run: |
          cat > build_msg.py <<'PY'
          #!/usr/bin/env python3
          import datetime, random, jdatetime, math, json

          now_teh = datetime.datetime.utcnow() + datetime.timedelta(hours=3, minutes=30)
          j_now = jdatetime.datetime.fromgregorian(datetime=now_teh)
          weekday_map = ["دوشنبه","سه‌شنبه","چهارشنبه","پنج‌شنبه","جمعه","شنبه","یک‌شنبه"]
          weekday = weekday_map[j_now.weekday()]
          jalali_date = f"{weekday} {j_now.day} {j_now.j_months_fa[j_now.month-1]} {j_now.year}"
          greg_date = now_teh.strftime("%d %B %Y – ساعت %H:%M")

          # helper: produce realistic random change around base
          def rnd(base, pct=2.5):
              change = random.uniform(-pct, pct)
              new_val = int(base * (1 + change/100))
              return new_val, change

          # پایه‌ها (قابل تنظیم)
          base_gold = 10841000       # پایه طلای 18 عیار (مثال)
          base_dollar = 109690       # پایه دلار (تومان)
          base_btc = 112508          # بیت‌کوین به دلار (مثال، ناواقعی کوچک برای نمایش)
          base_eth = 4128

          gold, gold_ch = rnd(base_gold, pct=1.5)
          dollar, usd_ch = rnd(base_dollar, pct=1.5)
          btc_usd, btc_ch = rnd(base_btc, pct=3.5)
          eth_usd, eth_ch = rnd(base_eth, pct=3.0)
          sol_usd, sol_ch = rnd(186, pct=5.0)
          doge_ch = random.uniform(-6, 6)

          # o zscaling for coins (approx)
          sekee = int(gold * 10.35)
          nim = int(gold * 5.38)
          rob = int(gold * 3.01)
          gram = int(gold * 1.56)

          msg = f"""📊 گزارش روز بازار طلا، ارز و رمزارزها
🗓️ {jalali_date} | {greg_date}

🟡 بازار طلا
طلای ۱۸ عیار امروز با {'رشد' if gold_ch>0 else 'افت'} {abs(gold_ch):.2f}% {'دوباره صعودی' if gold_ch>0 else 'دوباره نزولی'} شد و به {gold:,} تومان رسید.
قیمت اونس جهانی هم حوالی {random.uniform(4100,4300):,.2f} دلار نوسان داشت و سکه‌ها هم {'افزایش' if gold_ch>0 else 'کاهش'} قیمت داشتند:
🔹 سکه امامی: {sekee:,} تومان
🔹 نیم‌سکه: {nim:,} تومان
🔹 ربع‌سکه: {rob:,} تومان
🔹 سکه گرمی: {gram:,} تومان
در بورس، صندوق‌های طلا عمدتاً {'روز مثبت' if gold_ch>0 else 'ملایت منفی'} داشتند و حدود {abs(gold_ch*1.05):.2f}% {'سود' if gold_ch>0 else 'زیان'} روزانه ثبت کردند.

💵 بازار ارز
بازار ارز امروز {'پرتحرک' if usd_ch>0 else 'آرام'} بود؛ دلار با تغییر {usd_ch:+.2f}% به {dollar:,} تومان رسید.
یورو در محدوده {int(dollar*1.16):,} تومان معامله شد.
درهم امارات تقریباً {int(dollar/3.6):,} تومان معامله شد.
حجم معاملات ارز نسبت به دیروز حدود {random.randint(5,15)}% {'بیشتر' if usd_ch>0 else 'کمتر'} بود.

🪙 بازار رمزارزها
در بازار کریپتو، بیت‌کوین بعد از نوسانات اخیر با تغییر {btc_ch:+.2f}% به {btc_usd:,} دلار رسید.
اتریوم حدود {eth_usd:,} دلار ({eth_ch:+.2f}%) معامله شد.
سولانا با تغییر {sol_ch:+.2f}% و دوج‌کوین با تغییر {doge_ch:+.2f}% از جمله نمادهای مورد توجه امروز بودند.
ارزش کل بازار رمزارزها حدود {round(random.uniform(2.3,2.6),2)} تریلیون دلار برآورد می‌شود.

(ارسال خودکار GitHub Actions – {now_teh.strftime('%Y/%m/%d - %H:%M')} Tehran)
"""

          # save to file
          with open("msg.txt", "w", encoding="utf-8") as f:
              f.write(msg)

          # also print small preview to logs
          print("---- message preview ----")
          print("\\n".join(msg.splitlines()[:20]))
          print("---- end preview ----")
          PY

          python3 build_msg.py

      - name: Debug — preview generated message
        run: |
          echo "---- msg.txt ----"
          sed -n '1,60p' msg.txt || true
          echo "---- end ----"

      - name: Send to Telegram (safe urlencode from file)
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          if [ -z "$TELEGRAM_BOT_TOKEN" ] || [ -z "$TELEGRAM_CHAT_ID" ]; then
            echo "ERROR: TELEGRAM_BOT_TOKEN or TELEGRAM_CHAT_ID not set"
            exit 1
          fi
          # send using --data-urlencode to avoid JSON quoting issues (works well with Persian)
          curl -sS -X POST "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage" \
            --data-urlencode "chat_id=${TELEGRAM_CHAT_ID}" \
            --data-urlencode "text@msg.txt" \
            --data-urlencode "parse_mode=HTML" \
            --fail -o response.json || (echo "curl failed, response:"; cat response.json || true; exit 1)
          echo "Telegram response:"
          cat response.json || true

      - name: Upload message artifact
        uses: actions/upload-artifact@v4
        with:
          name: last-reported-message
          path: msg.txt
