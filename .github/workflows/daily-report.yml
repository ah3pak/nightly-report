name: Daily Telegram Report

on:
  schedule:
    # هر روز 17:30 UTC ≈ ساعت 21:00 تهران
    - cron: "30 17 * * *"
  workflow_dispatch: {}   # اجرای دستی برای تست

jobs:
  send:
    runs-on: ubuntu-latest

    steps:
      - name: Build message (inline)
        id: build
        run: |
          TODAY_IR="$(date -u -d '+3 hours 30 minutes' '+%Y/%m/%d - %H:%M (Tehran)')"
          cat > msg.txt <<EOF
          📊 گزارش روز بازار طلا، ارز و رمزارزها
          🗓️ دوشنبه ۲۶ مهر ۱۴۰۴ | ۱۸ اکتبر ۲۰۲۵ – ساعت ۲۱:۰۰

          🟡 بازار طلا
          طلای ۱۸ عیار: ۱۰,۸۴۰,۸۰۰ تومان
          سکه امامی: ۱۱۳,۱۸۰,۰۰۰ تومان
          نیم‌سکه: ۵۸,۴۰۰,۰۰۰ تومان | ربع‌سکه: ۳۲,۴۰۰,۰۰۰ تومان

          💵 بازار ارز
          دلار: ۱۰۸,۰۰۰ تومان | یورو: ۱۲۵,۹۰۰ تومان | درهم: —
          حجم معاملات نسبت به دیروز: —٪

          🪙 بازار رمزارزها
          بیت‌کوین: ۱۰۶,۹۰۰ دلار | اتریوم: ۳,۸۸۰ دلار
          سولانا: ۱۸۶ دلار | تتر: ۱۰۸,۰۰۰ تومان

          (ارسال خودکار GitHub Actions – $TODAY_IR)
          EOF
          # escape newline برای JSON
          MSG="$(python3 - <<'PY'
import json
print(json.dumps(open("msg.txt","r",encoding="utf-8").read()))
PY
          )"
          echo "message=$MSG" >> $GITHUB_OUTPUT

      - name: Send to Telegram
        run: |
          curl -sS -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage" \
            -H "Content-Type: application/json" \
            -d "{\"chat_id\":\"${{ secrets.TELEGRAM_CHAT_ID }}\",\"text\":${{ steps.build.outputs.message }},\"parse_mode\":\"HTML\",\"disable_web_page_preview\":true}"
