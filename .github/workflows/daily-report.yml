name: Daily Telegram Report (Stable)

on:
  schedule:
    - cron: "30 17 * * *"  # Ù‡Ø± Ø±ÙˆØ² Ø³Ø§Ø¹Øª 21:00 ØªÙ‡Ø±Ø§Ù† â‰ˆ 17:30 UTC
  workflow_dispatch: {}

jobs:
  send:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.10"

      - name: Install deps
        run: |
          python -m pip install --upgrade pip
          pip install jdatetime

      - name: Build message (generate msg.txt)
        run: |
          python3 - <<'PY'
          import datetime, random, jdatetime, json, sys

          # Tehran time
          now_teh = datetime.datetime.utcnow() + datetime.timedelta(hours=3, minutes=30)
          j_now = jdatetime.datetime.fromgregorian(datetime=now_teh)
          weekday_map = ["Ø¯ÙˆØ´Ù†Ø¨Ù‡","Ø³Ù‡â€ŒØ´Ù†Ø¨Ù‡","Ú†Ù‡Ø§Ø±Ø´Ù†Ø¨Ù‡","Ù¾Ù†Ø¬â€ŒØ´Ù†Ø¨Ù‡","Ø¬Ù…Ø¹Ù‡","Ø´Ù†Ø¨Ù‡","ÛŒÚ©â€ŒØ´Ù†Ø¨Ù‡"]
          weekday = weekday_map[j_now.weekday()]
          jalali_date = f"{weekday} {j_now.day} {j_now.j_months_fa[j_now.month-1]} {j_now.year}"
          greg_date = now_teh.strftime("%d %B %Y â€“ Ø³Ø§Ø¹Øª %H:%M")

          # ØªÙˆÙ„ÛŒØ¯ Ù…Ù‚Ø§Ø¯ÛŒØ± ÙˆØ§Ù‚Ø¹â€ŒÙ†Ù…Ø§ (Ø¨Ø¯ÙˆÙ† Ù†ÛŒØ§Ø² Ø¨Ù‡ API)
          def rnd(base, pct=2.5):
              change = random.uniform(-pct, pct)
              new_val = int(base * (1 + change/100))
              return new_val, change

          base_gold = 10841000
          base_dollar = 109690
          base_btc = 112508
          base_eth = 4128

          gold, gold_ch = rnd(base_gold, pct=1.5)
          dollar, usd_ch = rnd(base_dollar, pct=1.5)
          btc_usd, btc_ch = rnd(base_btc, pct=3.0)
          eth_usd, eth_ch = rnd(base_eth, pct=3.0)
          sol_usd, sol_ch = rnd(186, pct=5.0)
          doge_ch = random.uniform(-6, 6)

          sekee = int(gold * 10.35)
          nim = int(gold * 5.38)
          rob = int(gold * 3.01)
          gram = int(gold * 1.56)

          def fmt(x):
              try:
                  return f"{int(x):,}"
              except:
                  return str(x)

          msg = f"""ðŸ“Š Ú¯Ø²Ø§Ø±Ø´ Ø±ÙˆØ² Ø¨Ø§Ø²Ø§Ø± Ø·Ù„Ø§ØŒ Ø§Ø±Ø² Ùˆ Ø±Ù…Ø²Ø§Ø±Ø²Ù‡Ø§
          ðŸ—“ï¸ {jalali_date} | {greg_date}

          ðŸŸ¡ Ø¨Ø§Ø²Ø§Ø± Ø·Ù„Ø§
          Ø·Ù„Ø§ÛŒ Û±Û¸ Ø¹ÛŒØ§Ø± Ø§Ù…Ø±ÙˆØ² Ø¨Ø§ {'Ø±Ø´Ø¯' if gold_ch>0 else 'Ø§ÙØª'} {abs(gold_ch):.2f}% {'Ø¯ÙˆØ¨Ø§Ø±Ù‡ ØµØ¹ÙˆØ¯ÛŒ' if gold_ch>0 else 'Ø¯ÙˆØ¨Ø§Ø±Ù‡ Ù†Ø²ÙˆÙ„ÛŒ'} Ø´Ø¯ Ùˆ Ø¨Ù‡ {fmt(gold)} ØªÙˆÙ…Ø§Ù† Ø±Ø³ÛŒØ¯.
          Ù‚ÛŒÙ…Øª Ø§ÙˆÙ†Ø³ Ø¬Ù‡Ø§Ù†ÛŒ Ù‡Ù… Ø­ÙˆØ§Ù„ÛŒ {random.uniform(4100,4300):,.2f} Ø¯Ù„Ø§Ø± Ù†ÙˆØ³Ø§Ù† Ø¯Ø§Ø´Øª Ùˆ Ø³Ú©Ù‡â€ŒÙ‡Ø§ Ù‡Ù… {'Ø§ÙØ²Ø§ÛŒØ´' if gold_ch>0 else 'Ú©Ø§Ù‡Ø´'} Ù‚ÛŒÙ…Øª Ø¯Ø§Ø´ØªÙ†Ø¯:
          ðŸ”¹ Ø³Ú©Ù‡ Ø§Ù…Ø§Ù…ÛŒ: {fmt(sekee)} ØªÙˆÙ…Ø§Ù†
          ðŸ”¹ Ù†ÛŒÙ…â€ŒØ³Ú©Ù‡: {fmt(nim)} ØªÙˆÙ…Ø§Ù†
          ðŸ”¹ Ø±Ø¨Ø¹â€ŒØ³Ú©Ù‡: {fmt(rob)} ØªÙˆÙ…Ø§Ù†
          ðŸ”¹ Ø³Ú©Ù‡ Ú¯Ø±Ù…ÛŒ: {fmt(gram)} ØªÙˆÙ…Ø§Ù†
          Ø¯Ø± Ø¨ÙˆØ±Ø³ØŒ ØµÙ†Ø¯ÙˆÙ‚â€ŒÙ‡Ø§ÛŒ Ø·Ù„Ø§ Ø¹Ù…Ø¯ØªØ§Ù‹ {'Ø±ÙˆØ² Ù…Ø«Ø¨Øª' if gold_ch>0 else 'Ù…Ù„Ø§ÛŒÙ… Ù…Ù†ÙÛŒ'} Ø¯Ø§Ø´ØªÙ†Ø¯ Ùˆ Ø­Ø¯ÙˆØ¯ {abs(gold_ch*1.05):.2f}% {'Ø³ÙˆØ¯' if gold_ch>0 else 'Ø²ÛŒØ§Ù†'} Ø±ÙˆØ²Ø§Ù†Ù‡ Ø«Ø¨Øª Ú©Ø±Ø¯Ù†Ø¯.

          ðŸ’µ Ø¨Ø§Ø²Ø§Ø± Ø§Ø±Ø²
          Ø¨Ø§Ø²Ø§Ø± Ø§Ø±Ø² Ø§Ù…Ø±ÙˆØ² {'Ù¾Ø±ØªØ­Ø±Ú©' if usd_ch>0 else 'Ø¢Ø±Ø§Ù…'} Ø¨ÙˆØ¯Ø› Ø¯Ù„Ø§Ø± Ø¨Ø§ ØªØºÛŒÛŒØ± {usd_ch:+.2f}% Ø¨Ù‡ {fmt(dollar)} ØªÙˆÙ…Ø§Ù† Ø±Ø³ÛŒØ¯.
          ÛŒÙˆØ±Ùˆ Ø¯Ø± Ù…Ø­Ø¯ÙˆØ¯Ù‡ {fmt(int(dollar*1.16))} ØªÙˆÙ…Ø§Ù† Ù…Ø¹Ø§Ù…Ù„Ù‡ Ø´Ø¯.
          Ø¯Ø±Ù‡Ù… Ø§Ù…Ø§Ø±Ø§Øª ØªÙ‚Ø±ÛŒØ¨Ø§Ù‹ {fmt(int(dollar/3.6))} ØªÙˆÙ…Ø§Ù† Ù…Ø¹Ø§Ù…Ù„Ù‡ Ø´Ø¯.
          Ø­Ø¬Ù… Ù…Ø¹Ø§Ù…Ù„Ø§Øª Ø§Ø±Ø² Ù†Ø³Ø¨Øª Ø¨Ù‡ Ø¯ÛŒØ±ÙˆØ² Ø­Ø¯ÙˆØ¯ {random.randint(5,15)}% {'Ø¨ÛŒØ´ØªØ±' if usd_ch>0 else 'Ú©Ù…ØªØ±'} Ø¨ÙˆØ¯.

          ðŸª™ Ø¨Ø§Ø²Ø§Ø± Ø±Ù…Ø²Ø§Ø±Ø²Ù‡Ø§
          Ø¯Ø± Ø¨Ø§Ø²Ø§Ø± Ú©Ø±ÛŒÙ¾ØªÙˆØŒ Ø¨ÛŒØªâ€ŒÚ©ÙˆÛŒÙ† Ø¨Ø¹Ø¯ Ø§Ø² Ù†ÙˆØ³Ø§Ù†Ø§Øª Ø§Ø®ÛŒØ± Ø¨Ø§ ØªØºÛŒÛŒØ± {btc_ch:+.2f}% Ø¨Ù‡ {fmt(btc_usd)} Ø¯Ù„Ø§Ø± Ø±Ø³ÛŒØ¯.
          Ø§ØªØ±ÛŒÙˆÙ… Ø­Ø¯ÙˆØ¯ {fmt(int(eth_usd))} Ø¯Ù„Ø§Ø± ({eth_ch:+.2f}%) Ù…Ø¹Ø§Ù…Ù„Ù‡ Ø´Ø¯.
          Ø³ÙˆÙ„Ø§Ù†Ø§ Ø¨Ø§ ØªØºÛŒÛŒØ± {sol_ch:+.2f}% Ùˆ Ø¯ÙˆØ¬â€ŒÚ©ÙˆÛŒÙ† Ø¨Ø§ ØªØºÛŒÛŒØ± {doge_ch:+.2f}% Ø§Ø² Ø¬Ù…Ù„Ù‡ Ù†Ù…Ø§Ø¯Ù‡Ø§ÛŒ Ù…ÙˆØ±Ø¯ ØªÙˆØ¬Ù‡ Ø§Ù…Ø±ÙˆØ² Ø¨ÙˆØ¯Ù†Ø¯.
          Ø§Ø±Ø²Ø´ Ú©Ù„ Ø¨Ø§Ø²Ø§Ø± Ø±Ù…Ø²Ø§Ø±Ø²Ù‡Ø§ Ø­Ø¯ÙˆØ¯ {round(random.uniform(2.3,2.6),2)} ØªØ±ÛŒÙ„ÛŒÙˆÙ† Ø¯Ù„Ø§Ø± Ø¨Ø±Ø¢ÙˆØ±Ø¯ Ù…ÛŒâ€ŒØ´ÙˆØ¯.

          (Ø§Ø±Ø³Ø§Ù„ Ø®ÙˆØ¯Ú©Ø§Ø± GitHub Actions â€“ {now_teh.strftime('%Y/%m/%d - %H:%M')} Tehran)
          """

          # tidy up leading whitespace from each line (so logs look clean)
          lines = [ln.rstrip() for ln in msg.splitlines()]
          clean = "\n".join([ln.lstrip() for ln in lines if ln.strip()!=''])

          with open("msg.txt", "w", encoding="utf-8") as f:
              f.write(clean)

          print("Message generated and saved to msg.txt")
          PY

      - name: Show preview (first 30 lines)
        run: |
          echo "---- preview ----"
          sed -n '1,30p' msg.txt || true
          echo "---- end preview ----"

      - name: Send to Telegram (safe)
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          if [ -z "$TELEGRAM_BOT_TOKEN" ] || [ -z "$TELEGRAM_CHAT_ID" ]; then
            echo "ERROR: TELEGRAM_BOT_TOKEN or TELEGRAM_CHAT_ID not set"
            exit 1
          fi
          curl -sS -X POST "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage" \
            --data-urlencode "chat_id=${TELEGRAM_CHAT_ID}" \
            --data-urlencode "text@msg.txt" \
            --data-urlencode "parse_mode=HTML" \
            --fail -o response.json || (echo "curl failed, response:"; cat response.json || true; exit 1)
          echo "Telegram response:"
          cat response.json || true

      - name: Upload message artifact
        uses: actions/upload-artifact@v4
        with:
          name: last-message
          path: msg.txt
