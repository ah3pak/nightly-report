name: Daily Telegram Report

on:
  schedule:
    - cron: "30 17 * * *"   # Ù‡Ø± Ø±ÙˆØ² Ø³Ø§Ø¹Øª 21:00 ØªÙ‡Ø±Ø§Ù† (17:30 UTC)
  workflow_dispatch: {}

jobs:
  send:
    runs-on: ubuntu-latest

    steps:
      - name: Install deps
        run: |
          python3 -m pip install --upgrade pip
          pip install jdatetime requests

      - name: Build message (Jalali date + TGJU + Nobitex)
        id: build
        run: |
          python3 - <<'PY'
          import re, json, requests
          from datetime import datetime, timedelta
          import jdatetime

          # ---------- helpers
          def iran_now():
              return datetime.utcnow() + timedelta(hours=3, minutes=30)

          fa_map = str.maketrans("0123456789", "Û°Û±Û²Û³Û´ÛµÛ¶Û·Û¸Û¹")
          def fa_num(s): return str(s).translate(fa_map)

          def commatize(n):
              if n is None: return "â€”"
              s = re.sub(r"[^\d.]", "", str(n))
              if s == "": return "â€”"
              i, _, d = s.partition(".")
              out = f"{int(i):,}"
              if d: out += "." + d
              return fa_num(out)

          def pct_text(p):
              if p is None: return "â€”"
              s = re.sub(r"[^\d\.\-]", "", str(p))
              if s == "": return "â€”"
              v = float(s)
              if v > 0: trend = "Ø±Ø´Ø¯"
              elif v < 0: trend = "Ø§ÙØª"
              else: trend = "Ø¨Ø¯ÙˆÙ† ØªØºÛŒÛŒØ±"
              return f"{fa_num(f'{abs(v):.2f}')}Ùª {trend}"

          # ---------- TGJU scraping (last_price, change_percent)
          def tgju_fetch(url):
              r = requests.get(url, headers={"User-Agent":"Mozilla/5.0"}, timeout=20)
              r.raise_for_status()
              h = r.text
              m_price = re.search(r'"last_price"\s*:\s*"?(?P<v>-?\d[\d,\.]*)', h)
              m_pct   = re.search(r'"change_percent"\s*:\s*"?(?P<v>-?\d[\d\.]*)', h)
              price = m_price.group("v") if m_price else None
              pct   = m_pct.group("v") if m_pct else None
              return price, pct

          TGJU = {
            "gold18": "https://www.tgju.org/profile/gold-18",
            "coin_emami": "https://www.tgju.org/profile/sekke",
            "coin_nim":   "https://www.tgju.org/profile/sekke-nim",
            "coin_rob":   "https://www.tgju.org/profile/sekke-rob",
            "coin_gerami":"https://www.tgju.org/profile/sekke-gerami",
            "usd": "https://www.tgju.org/profile/price_dollar_rl",
            "eur": "https://www.tgju.org/profile/price_eur",
            "aed": "https://www.tgju.org/profile/price_aed",
            "xauusd": "https://www.tgju.org/profile/ounce"
          }

          g18, g18p = tgju_fetch(TGJU["gold18"])
          emami, _  = tgju_fetch(TGJU["coin_emami"])
          nim,   _  = tgju_fetch(TGJU["coin_nim"])
          rob,   _  = tgju_fetch(TGJU["coin_rob"])
          gerami,_  = tgju_fetch(TGJU["coin_gerami"])
          usd, usdp = tgju_fetch(TGJU["usd"])
          eur, eurp = tgju_fetch(TGJU["eur"])
          aed, aedp = tgju_fetch(TGJU["aed"])
          xau, _    = tgju_fetch(TGJU["xauusd"])

          # ---------- Nobitex IRT (ØªÙˆÙ…Ø§Ù†)   (BTC/ETH/SOL/BNB/USDT)
          # Ø¢Ø¯Ø±Ø³ Ø¹Ù…ÙˆÙ…ÛŒ ÙˆØ¶Ø¹ÛŒØª Ø¨Ø§Ø²Ø§Ø± Ø¨Ø±Ø§ÛŒ Ú†Ù†Ø¯ Ù†Ù…Ø§Ø¯
          symbols = ["BTCIRT","ETHIRT","SOLIRT","BNBIRT","USDTIRT"]
          nb = requests.get(
              "https://api.nobitex.ir/market/stats",
              params={"symbol": ",".join(symbols)},
              timeout=20,
              headers={"User-Agent":"Mozilla/5.0"}
          ).json().get("statistics", {})

          def nobi_latest(sym):
              d = nb.get(sym, {})
              return d.get("latest")

          btc_irt = nobi_latest("BTCIRT")
          eth_irt = nobi_latest("ETHIRT")
          sol_irt = nobi_latest("SOLIRT")
          bnb_irt = nobi_latest("BNBIRT")
          usdt_irt= nobi_latest("USDTIRT")

          # ---------- Date (Jalali + Gregorian)
          now_g = iran_now()
          now_j = jdatetime.datetime.fromgregorian(datetime=now_g)
          weekdays = ["Ø¯ÙˆØ´Ù†Ø¨Ù‡","Ø³Ù‡â€ŒØ´Ù†Ø¨Ù‡","Ú†Ù‡Ø§Ø±Ø´Ù†Ø¨Ù‡","Ù¾Ù†Ø¬Ø´Ù†Ø¨Ù‡","Ø¬Ù…Ø¹Ù‡","Ø´Ù†Ø¨Ù‡","ÛŒÚ©Ø´Ù†Ø¨Ù‡"]
          months_j = ["ÙØ±ÙˆØ±Ø¯ÛŒÙ†","Ø§Ø±Ø¯ÛŒØ¨Ù‡Ø´Øª","Ø®Ø±Ø¯Ø§Ø¯","ØªÛŒØ±","Ù…Ø±Ø¯Ø§Ø¯","Ø´Ù‡Ø±ÛŒÙˆØ±",
                      "Ù…Ù‡Ø±","Ø¢Ø¨Ø§Ù†","Ø¢Ø°Ø±","Ø¯ÛŒ","Ø¨Ù‡Ù…Ù†","Ø§Ø³ÙÙ†Ø¯"]
          months_g = ["Ú˜Ø§Ù†ÙˆÛŒÙ‡","ÙÙˆØ±ÛŒÙ‡","Ù…Ø§Ø±Ø³","Ø¢ÙˆØ±ÛŒÙ„","Ù…Ù‡","Ú˜ÙˆØ¦Ù†",
                      "Ú˜ÙˆØ¦ÛŒÙ‡","Ø§ÙˆØª","Ø³Ù¾ØªØ§Ù…Ø¨Ø±","Ø§Ú©ØªØ¨Ø±","Ù†ÙˆØ§Ù…Ø¨Ø±","Ø¯Ø³Ø§Ù…Ø¨Ø±"]

          header = f"{weekdays[now_j.weekday()]} {fa_num(now_j.day)} {months_j[now_j.month-1]} {fa_num(now_j.year)} | {fa_num(now_g.day)} {months_g[now_g.month-1]} {fa_num(now_g.year)} â€“ Ø³Ø§Ø¹Øª Û²Û±:Û°Û°"

          # ---------- Build sections
          gold_line = f"Ø·Ù„Ø§ÛŒ Û±Û¸ Ø¹ÛŒØ§Ø± Ø§Ù…Ø±ÙˆØ² Ø¨Ø§ {pct_text(g18p)} Ø¨Ù‡ {commatize(g18)} ØªÙˆÙ…Ø§Ù† Ø±Ø³ÛŒØ¯."
          coin_lines = "\n".join([
            f"ğŸ”¹ Ø³Ú©Ù‡ Ø§Ù…Ø§Ù…ÛŒ: {commatize(emami)} ØªÙˆÙ…Ø§Ù†",
            f"ğŸ”¹ Ù†ÛŒÙ…â€ŒØ³Ú©Ù‡: {commatize(nim)} ØªÙˆÙ…Ø§Ù†",
            f"ğŸ”¹ Ø±Ø¨Ø¹â€ŒØ³Ú©Ù‡: {commatize(rob)} ØªÙˆÙ…Ø§Ù†",
            f"ğŸ”¹ Ø³Ú©Ù‡ Ú¯Ø±Ù…ÛŒ: {commatize(gerami)} ØªÙˆÙ…Ø§Ù†",
          ])

          fx_line = " | ".join([
            f"Ø¯Ù„Ø§Ø±: {commatize(usd)} ØªÙˆÙ…Ø§Ù†",
            f"ÛŒÙˆØ±Ùˆ: {commatize(eur)} ØªÙˆÙ…Ø§Ù†",
            f"Ø¯Ø±Ù‡Ù…: {commatize(aed)} ØªÙˆÙ…Ø§Ù†"
          ])

          crypto_lines = " | ".join([
            f"Ø¨ÛŒØªâ€ŒÚ©ÙˆÛŒÙ†: {commatize(btc_irt)} ØªÙˆÙ…Ø§Ù†",
            f"Ø§ØªØ±ÛŒÙˆÙ…: {commatize(eth_irt)} ØªÙˆÙ…Ø§Ù†",
            f"Ø³ÙˆÙ„Ø§Ù†Ø§: {commatize(sol_irt)} ØªÙˆÙ…Ø§Ù†",
            f"Ø¨Ø§ÛŒÙ†Ù†Ø³â€ŒÚ©ÙˆÛŒÙ†: {commatize(bnb_irt)} ØªÙˆÙ…Ø§Ù†",
            f"ØªØªØ±: {commatize(usdt_irt)} ØªÙˆÙ…Ø§Ù†",
          ])

          # ounce line (Ø¯Ù„Ø§Ø±ÛŒ)
          ounce_line = f"Ø§ÙˆÙ†Ø³ Ø¬Ù‡Ø§Ù†ÛŒ Ø·Ù„Ø§: {commatize(xau)} Ø¯Ù„Ø§Ø±"

          msg = f"""ğŸ“Š Ú¯Ø²Ø§Ø±Ø´ Ø±ÙˆØ² Ø¨Ø§Ø²Ø§Ø± Ø·Ù„Ø§ØŒ Ø§Ø±Ø² Ùˆ Ø±Ù…Ø²Ø§Ø±Ø²Ù‡Ø§
          {header}

          ğŸŸ¡ Ø¨Ø§Ø²Ø§Ø± Ø·Ù„Ø§
          {gold_line}
          {coin_lines}

          ğŸ’µ Ø¨Ø§Ø²Ø§Ø± Ø§Ø±Ø²
          {fx_line}

          ğŸª™ Ø¨Ø§Ø²Ø§Ø± Ø±Ù…Ø²Ø§Ø±Ø²Ù‡Ø§
          {crypto_lines}

          ({fa_num(now_j.strftime('%Y/%m/%d'))} â€“ Ø§Ø±Ø³Ø§Ù„ Ø®ÙˆØ¯Ú©Ø§Ø± GitHub Actions)
          """.strip()

          print("::set-output name=message::" + json.dumps(msg, ensure_ascii=False))
          PY

      - name: Send to Telegram
        run: |
          curl -sS -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage" \
            -H "Content-Type: application/json" \
            -d "{\"chat_id\":\"${{ secrets.TELEGRAM_CHAT_ID }}\",\"text\":${{ steps.build.outputs.message }},\"parse_mode\":\"HTML\",\"disable_web_page_preview\":true}"
