name: Daily Telegram Report

on:
  schedule:
    - cron: "30 17 * * *" # Ù‡Ø± Ø±ÙˆØ² Ø³Ø§Ø¹Øª 21:00 ØªÙ‡Ø±Ø§Ù† â‰ˆ 17:30 UTC
  workflow_dispatch:

jobs:
  send:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.x"

      - name: Install dependencies
        run: |
          sudo apt-get update -y
          python -m pip install --upgrade pip
          pip install requests jdatetime

      - name: Build message (Jalali date + TGJU + Nobitex)
        run: |
          python3 - <<'PY'
          import requests, jdatetime, datetime, json
          
          # Ø²Ù…Ø§Ù† ØªÙ‡Ø±Ø§Ù†
          now_teh = datetime.datetime.utcnow() + datetime.timedelta(hours=3, minutes=30)
          j_now = jdatetime.datetime.fromgregorian(datetime=now_teh)
          weekday_map = ["Ø¯ÙˆØ´Ù†Ø¨Ù‡","Ø³Ù‡â€ŒØ´Ù†Ø¨Ù‡","Ú†Ù‡Ø§Ø±Ø´Ù†Ø¨Ù‡","Ù¾Ù†Ø¬â€ŒØ´Ù†Ø¨Ù‡","Ø¬Ù…Ø¹Ù‡","Ø´Ù†Ø¨Ù‡","ÛŒÚ©â€ŒØ´Ù†Ø¨Ù‡"]
          weekday = weekday_map[j_now.weekday()]
          jalali_months = j_now.j_months_fa
          jalali_date = f"{weekday} {j_now.day} {jalali_months[j_now.month-1]} {j_now.year}"
          greg_date = now_teh.strftime("%d %B %Y â€“ Ø³Ø§Ø¹Øª %H:%M")
          
          # TGJU Ø¢ÛŒØªÙ…â€ŒÙ‡Ø§ (Ù…Ù†Ø§Ø³Ø¨ Ø¨Ø±Ø§ÛŒ endpoints chart-summary)
          tgju_items = {
              "Ø·Ù„Ø§ÛŒ Û±Û¸ Ø¹ÛŒØ§Ø±": "geram18",
              "Ø³Ú©Ù‡ Ø§Ù…Ø§Ù…ÛŒ": "sekee",
              "Ù†ÛŒÙ…â€ŒØ³Ú©Ù‡": "sekne-nim",
              "Ø±Ø¨Ø¹â€ŒØ³Ú©Ù‡": "sekne-rob",
              "Ø¯Ù„Ø§Ø±": "price_dollar_rl",
              "ÛŒÙˆØ±Ùˆ": "price_eur"
          }
          
          tgju_data = {}
          for name, code in tgju_items.items():
              try:
                  url = f"https://www.tgju.org/chart-summary/{code}"
                  r = requests.get(url, timeout=15)
                  r.raise_for_status()
                  data = r.json()
                  p = None
                  if isinstance(data, dict):
                      # ØªÙ„Ø§Ø´ Ø¨Ø±Ø§ÛŒ Ø®ÙˆØ§Ù†Ø¯Ù† Ù…Ø³ÛŒØ± Ù…Ø¹Ù…ÙˆÙ„
                      cur = data.get("current") or {}
                      p = cur.get("p") if cur else data.get("p")
                  # ØªØ¨Ø¯ÛŒÙ„ Ø¨Ù‡ Ø¹Ø¯Ø¯ ÛŒØ§ Ù†Ú¯Ù‡â€ŒØ¯Ø§Ø±ÛŒ Ø±Ø´ØªÙ‡
                  if p is None:
                      tgju_data[name] = 0
                  else:
                      # remove commas and cast if Ù…Ù…Ú©Ù†
                      try:
                          tgju_data[name] = int(float(str(p).replace(',', '')))
                      except:
                          tgju_data[name] = str(p)
              except Exception as e:
                  tgju_data[name] = 0
          
          # Nobitex symbols
          nobitex_symbols = {
              "BTC": "btc-usdt",
              "ETH": "eth-usdt",
              "SOL": "sol-usdt",
              "BNB": "bnb-usdt",
              "USDT": "usdt-rls"
          }
          
          nobi_prices = {}
          for sym, pair in nobitex_symbols.items():
              try:
                  r = requests.get(f"https://api.nobitex.ir/market/stats?symbol={pair}", timeout=15)
                  r.raise_for_status()
                  data = r.json()
                  stats = data.get("stats", {})
                  val = stats.get(pair, {}).get("latest")
                  nobi_prices[sym] = float(val) if val is not None else 0.0
              except:
                  nobi_prices[sym] = 0.0
          
          t_usdt = nobi_prices.get("USDT", 0.0) or 0.0
          
          def fmt(x):
              try:
                  return f"{int(x):,}"
              except:
                  return str(x)
          
          msg = f"""ðŸ“Š Ú¯Ø²Ø§Ø±Ø´ Ø±ÙˆØ² Ø¨Ø§Ø²Ø§Ø± Ø·Ù„Ø§ØŒ Ø§Ø±Ø² Ùˆ Ø±Ù…Ø²Ø§Ø±Ø²Ù‡Ø§
          ðŸ—“ï¸ {jalali_date} | {greg_date}
          
          ðŸŸ¡ Ø¨Ø§Ø²Ø§Ø± Ø·Ù„Ø§
          Ø·Ù„Ø§ÛŒ Û±Û¸ Ø¹ÛŒØ§Ø±: {fmt(tgju_data.get('Ø·Ù„Ø§ÛŒ Û±Û¸ Ø¹ÛŒØ§Ø±', 0))} ØªÙˆÙ…Ø§Ù†
          Ø³Ú©Ù‡ Ø§Ù…Ø§Ù…ÛŒ: {fmt(tgju_data.get('Ø³Ú©Ù‡ Ø§Ù…Ø§Ù…ÛŒ', 0))} ØªÙˆÙ…Ø§Ù†
          Ù†ÛŒÙ…â€ŒØ³Ú©Ù‡: {fmt(tgju_data.get('Ù†ÛŒÙ…â€ŒØ³Ú©Ù‡', 0))} ØªÙˆÙ…Ø§Ù†
          Ø±Ø¨Ø¹â€ŒØ³Ú©Ù‡: {fmt(tgju_data.get('Ø±Ø¨Ø¹â€ŒØ³Ú©Ù‡', 0))} ØªÙˆÙ…Ø§Ù†
          
          ðŸ’µ Ø¨Ø§Ø²Ø§Ø± Ø§Ø±Ø²
          Ø¯Ù„Ø§Ø±: {fmt(tgju_data.get('Ø¯Ù„Ø§Ø±', 0))} ØªÙˆÙ…Ø§Ù† | ÛŒÙˆØ±Ùˆ: {fmt(tgju_data.get('ÛŒÙˆØ±Ùˆ', 0))} ØªÙˆÙ…Ø§Ù†
          
          ðŸª™ Ø¨Ø§Ø²Ø§Ø± Ø±Ù…Ø²Ø§Ø±Ø²Ù‡Ø§ (Ù†ÙˆØ¨ÛŒØªÚ©Ø³)
          Ø¨ÛŒØªâ€ŒÚ©ÙˆÛŒÙ†: {nobi_prices.get('BTC',0):.2f} USDT â‰ˆ {int(nobi_prices.get('BTC',0)*t_usdt):,} ØªÙˆÙ…Ø§Ù†
          Ø§ØªØ±ÛŒÙˆÙ…: {nobi_prices.get('ETH',0):.2f} USDT â‰ˆ {int(nobi_prices.get('ETH',0)*t_usdt):,} ØªÙˆÙ…Ø§Ù†
          Ø³ÙˆÙ„Ø§Ù†Ø§: {nobi_prices.get('SOL',0):.2f} USDT â‰ˆ {int(nobi_prices.get('SOL',0)*t_usdt):,} ØªÙˆÙ…Ø§Ù†
          Ø¨Ø§ÛŒÙ†Ù†Ø³â€ŒÚ©ÙˆÛŒÙ†: {nobi_prices.get('BNB',0):.2f} USDT â‰ˆ {int(nobi_prices.get('BNB',0)*t_usdt):,} ØªÙˆÙ…Ø§Ù†
          ØªØªØ±: {int(t_usdt):,} ØªÙˆÙ…Ø§Ù†
          
          (Ø§Ø±Ø³Ø§Ù„ Ø®ÙˆØ¯Ú©Ø§Ø± GitHub Actions â€“ {now_teh.strftime('%Y/%m/%d - %H:%M')} Tehran)
          """
          
          # Ù¾Ø§Ú©â€ŒØ³Ø§Ø²ÛŒ Ø®Ø·ÙˆØ· Ø§Ø¶Ø§ÙÛŒ Ø§Ø¨ØªØ¯Ø§/Ø§Ù†ØªÙ‡Ø§
          msg = "\n".join([line.rstrip() for line in msg.strip().splitlines()])
          
          with open("msg.txt", "w", encoding="utf-8") as f:
              f.write(msg)
          
          print("âœ… Message built and saved to msg.txt")
          PY

      - name: Debug â€” show short preview of msg
        run: |
          echo "---- preview (first 20 lines) ----"
          head -n 20 msg.txt || true
          echo "---- end preview ----"

      - name: Send to Telegram
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          if [ -z "$TELEGRAM_BOT_TOKEN" ] || [ -z "$TELEGRAM_CHAT_ID" ]; then
            echo "ERROR: Secrets TELEGRAM_BOT_TOKEN or TELEGRAM_CHAT_ID not set"
            exit 1
          fi
          # Ø§Ø±Ø³Ø§Ù„ Ø¨Ø§ form-urlencoded ØªØ§ Ù…Ø´Ú©Ù„ Ù†Ù‚Ù„â€ŒÙ‚ÙˆÙ„ Ùˆ encoding Ù†Ø¨Ø§Ø´Ø¯
          curl -sS -X POST "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage" \
            --data-urlencode "chat_id=${TELEGRAM_CHAT_ID}" \
            --data-urlencode "text@msg.txt" \
            --data-urlencode "parse_mode=HTML" \
            --fail -o response.json || (echo "curl failed"; cat response.json || true; exit 1)
          echo "âœ… Message sent; response:"
          cat response.json || true
