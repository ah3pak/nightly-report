name: Daily Telegram Report (Final Stable)

on:
  schedule:
    - cron: "30 17 * * *"   # Ù‡Ø± Ø±ÙˆØ² Ø³Ø§Ø¹Øª 21:00 ØªÙ‡Ø±Ø§Ù† (17:30 UTC)
  workflow_dispatch:

jobs:
  send:
    runs-on: ubuntu-latest

    steps:
      - name: Build message
        id: build
        run: |
          python3 - <<'PY'
          import datetime, random, json, jdatetime

          # ØªØ§Ø±ÛŒØ® Ø´Ù…Ø³ÛŒ Ùˆ Ù…ÛŒÙ„Ø§Ø¯ÛŒ
          now_teh = datetime.datetime.utcnow() + datetime.timedelta(hours=3, minutes=30)
          j_now = jdatetime.datetime.fromgregorian(datetime=now_teh)
          weekday_map = ["Ø¯ÙˆØ´Ù†Ø¨Ù‡","Ø³Ù‡â€ŒØ´Ù†Ø¨Ù‡","Ú†Ù‡Ø§Ø±Ø´Ù†Ø¨Ù‡","Ù¾Ù†Ø¬â€ŒØ´Ù†Ø¨Ù‡","Ø¬Ù…Ø¹Ù‡","Ø´Ù†Ø¨Ù‡","ÛŒÚ©â€ŒØ´Ù†Ø¨Ù‡"]
          weekday = weekday_map[j_now.weekday()]
          jalali_date = f"{weekday} {j_now.day} {j_now.j_months_fa[j_now.month-1]} {j_now.year}"
          greg_date = now_teh.strftime("%d %B %Y â€“ Ø³Ø§Ø¹Øª %H:%M")

          # Ø´Ø¨ÛŒÙ‡â€ŒØ³Ø§Ø²ÛŒ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§
          def rnd(base, pct=2.5):
              change = random.uniform(-pct, pct)
              new_val = int(base * (1 + change/100))
              return new_val, change

          gold, gold_ch = rnd(10800000)
          dollar, usd_ch = rnd(109000)
          btc_usd, btc_ch = rnd(110000)
          eth_usd, eth_ch = rnd(4000)
          sol_usd, sol_ch = rnd(180)
          doge_ch = random.uniform(-5,5)

          msg = f"""ðŸ“Š Ú¯Ø²Ø§Ø±Ø´ Ø±ÙˆØ² Ø¨Ø§Ø²Ø§Ø± Ø·Ù„Ø§ØŒ Ø§Ø±Ø² Ùˆ Ø±Ù…Ø²Ø§Ø±Ø²Ù‡Ø§
ðŸ—“ï¸ {jalali_date} | {greg_date}

ðŸŸ¡ Ø¨Ø§Ø²Ø§Ø± Ø·Ù„Ø§
Ø·Ù„Ø§ÛŒ Û±Û¸ Ø¹ÛŒØ§Ø± Ø§Ù…Ø±ÙˆØ² Ø¨Ø§ {'Ø±Ø´Ø¯' if gold_ch>0 else 'Ø§ÙØª'} {abs(gold_ch):.2f}Ùª {'ØµØ¹ÙˆØ¯ÛŒ' if gold_ch>0 else 'Ù†Ø²ÙˆÙ„ÛŒ'} Ø´Ø¯ Ùˆ Ø¨Ù‡ {gold:,} ØªÙˆÙ…Ø§Ù† Ø±Ø³ÛŒØ¯.
Ù‚ÛŒÙ…Øª Ø§ÙˆÙ†Ø³ Ø¬Ù‡Ø§Ù†ÛŒ Ù‡Ù… ØªØ§ {random.uniform(4100,4300):,.2f} Ø¯Ù„Ø§Ø± {'Ø¨Ø§Ù„Ø§ Ø±ÙØª' if gold_ch>0 else 'Ù¾Ø§ÛŒÛŒÙ† Ø¢Ù…Ø¯'} Ùˆ Ø³Ú©Ù‡â€ŒÙ‡Ø§ Ù‡Ù… {'Ø§ÙØ²Ø§ÛŒØ´' if gold_ch>0 else 'Ú©Ø§Ù‡Ø´'} Ù‚ÛŒÙ…Øª Ø¯Ø§Ø´ØªÙ†Ø¯:
ðŸ”¹ Ø³Ú©Ù‡ Ø§Ù…Ø§Ù…ÛŒ: {int(gold*10.4):,} ØªÙˆÙ…Ø§Ù†
ðŸ”¹ Ù†ÛŒÙ…â€ŒØ³Ú©Ù‡: {int(gold*5.3):,} ØªÙˆÙ…Ø§Ù†
ðŸ”¹ Ø±Ø¨Ø¹â€ŒØ³Ú©Ù‡: {int(gold*2.9):,} ØªÙˆÙ…Ø§Ù†
ðŸ”¹ Ø³Ú©Ù‡ Ú¯Ø±Ù…ÛŒ: {int(gold*1.5):,} ØªÙˆÙ…Ø§Ù†
Ø¯Ø± Ø¨ÙˆØ±Ø³ØŒ ØµÙ†Ø¯ÙˆÙ‚â€ŒÙ‡Ø§ÛŒ Ø·Ù„Ø§ Ù‡Ù… Ø±ÙˆØ² {'Ù…Ø«Ø¨ØªÛŒ' if gold_ch>0 else 'Ù…Ù†ÙÛŒ'} Ø¯Ø§Ø´ØªÙ†Ø¯ Ùˆ Ø­Ø¯ÙˆØ¯ {abs(gold_ch*1.1):.2f}Ùª {'Ø³ÙˆØ¯' if gold_ch>0 else 'Ø²ÛŒØ§Ù†'} Ø±ÙˆØ²Ø§Ù†Ù‡ Ø«Ø¨Øª Ú©Ø±Ø¯Ù†Ø¯.

ðŸ’µ Ø¨Ø§Ø²Ø§Ø± Ø§Ø±Ø²
Ø¨Ø§Ø²Ø§Ø± Ø§Ø±Ø² Ø§Ù…Ø±ÙˆØ² {'Ù¾Ø±Ù†ÙˆØ³Ø§Ù† Ùˆ Ø§ÙØ²Ø§ÛŒØ´ÛŒ' if usd_ch>0 else 'Ø¢Ø±Ø§Ù… Ùˆ Ú©Ø§Ù‡Ø´ÛŒ'} Ø¨ÙˆØ¯Ø› Ø¯Ù„Ø§Ø± Ø¨Ø§ ØªØºÛŒÛŒØ± {usd_ch:+.2f}Ùª Ø¨Ù‡ {dollar:,} ØªÙˆÙ…Ø§Ù† Ø±Ø³ÛŒØ¯.
ÛŒÙˆØ±Ùˆ Ø¯Ø± Ù…Ø­Ø¯ÙˆØ¯Ù‡ {int(dollar*1.16):,} ØªÙˆÙ…Ø§Ù† ({'+' if usd_ch>0 else ''}{usd_ch:.2f}Ùª)ØŒ
Ø¯Ø±Ù‡Ù… Ø§Ù…Ø§Ø±Ø§Øª Ø­Ø¯ÙˆØ¯ {int(dollar/3.6):,} ØªÙˆÙ…Ø§Ù† Ù…Ø¹Ø§Ù…Ù„Ù‡ Ø´Ø¯.
Ø­Ø¬Ù… Ù…Ø¹Ø§Ù…Ù„Ø§Øª Ø§Ø±Ø² Ù†Ø³Ø¨Øª Ø¨Ù‡ Ø¯ÛŒØ±ÙˆØ² Ø­Ø¯ÙˆØ¯ {random.randint(5,15)}Ùª {'Ø¨ÛŒØ´ØªØ±' if usd_ch>0 else 'Ú©Ù…ØªØ±'} Ø¨ÙˆØ¯ Ú©Ù‡ Ù†Ø´Ø§Ù† Ù…ÛŒâ€ŒØ¯Ù‡Ø¯ Ø¨Ø§Ø²Ø§Ø± Ù‡Ù†ÙˆØ² {'Ø¯Ø± ÙØ§Ø² Ù¾Ø±Ù†ÙˆØ³Ø§Ù† Ù‚Ø±Ø§Ø± Ø¯Ø§Ø±Ø¯' if usd_ch>0 else 'ØªÙ…Ø§ÛŒÙ„ Ø¨Ù‡ Ø«Ø¨Ø§Øª Ø¯Ø§Ø±Ø¯'}.

ðŸª™ Ø¨Ø§Ø²Ø§Ø± Ø±Ù…Ø²Ø§Ø±Ø²Ù‡Ø§
Ø¯Ø± Ø¨Ø§Ø²Ø§Ø± Ú©Ø±ÛŒÙ¾ØªÙˆØŒ Ø¨ÛŒØªâ€ŒÚ©ÙˆÛŒÙ† Ø¨Ø¹Ø¯ Ø§Ø² Ù†ÙˆØ³Ø§Ù†Ø§Øª Ø§Ø®ÛŒØ±ØŒ Ø¨Ø§ ØªØºÛŒÛŒØ± {btc_ch:+.2f}Ùª Ø¨Ù‡ {btc_usd:,} Ø¯Ù„Ø§Ø± Ø±Ø³ÛŒØ¯.
Ø§ØªØ±ÛŒÙˆÙ… Ø¯Ø± Ù…Ø­Ø¯ÙˆØ¯Ù‡ {eth_usd:,} Ø¯Ù„Ø§Ø± ({eth_ch:+.2f}Ùª) Ù…Ø¹Ø§Ù…Ù„Ù‡ Ø´Ø¯.
Ø³ÙˆÙ„Ø§Ù†Ø§ Ø¨Ø§ {sol_ch:+.2f}Ùª Ùˆ Ø¯ÙˆØ¬â€ŒÚ©ÙˆÛŒÙ† Ø¨Ø§ {doge_ch:+.2f}Ùª {'Ø¯Ø± ØµØ¯Ø± Ø±Ù…Ø²Ø§Ø±Ø²Ù‡Ø§ÛŒ Ø³Ø¨Ø²' if sol_ch>0 else 'Ø¯Ø± Ø¨ÛŒÙ† Ù‚Ø±Ù…Ø²Ù‡Ø§ÛŒ Ø§Ù…Ø±ÙˆØ²'} Ø¨ÙˆØ¯Ù†Ø¯.
Ø§Ø±Ø²Ø´ Ú©Ù„ Ø¨Ø§Ø²Ø§Ø± Ø±Ù…Ø²Ø§Ø±Ø²Ù‡Ø§ Ø­Ø§Ù„Ø§ Ø­Ø¯ÙˆØ¯ {round(random.uniform(2.3,2.6),2)} ØªØ±ÛŒÙ„ÛŒÙˆÙ† Ø¯Ù„Ø§Ø± Ø¨Ø±Ø¢ÙˆØ±Ø¯ Ù…ÛŒâ€ŒØ´ÙˆØ¯.

(Ø§Ø±Ø³Ø§Ù„ Ø®ÙˆØ¯Ú©Ø§Ø± GitHub Actions â€“ {now_teh.strftime('%Y/%m/%d - %H:%M')} Tehran)
"""
          msg_json = json.dumps(msg, ensure_ascii=False)
          print(msg)
          print(f"::set-output name=message::{msg_json}")
          PY

      - name: Send to Telegram
        run: |
          curl -sS -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage" \
            -H "Content-Type: application/json" \
            -d "{\"chat_id\":\"${{ secrets.TELEGRAM_CHAT_ID }}\",\"text\":${{ steps.build.outputs.message }},\"parse_mode\":\"HTML\"}"
